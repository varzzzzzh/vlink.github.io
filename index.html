<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1f22">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VLink | Secure Chat</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@8/build/umd.js"></script>

    <style>
        /* ==========================================
           CORE DARK THEME & LAYOUT
           ========================================== */
        :root {
            --bg-sidebar: #1e1f22; 
            --bg-friends: #2b2d31; 
            --bg-chat: #313338;
            --text-main: #dbdee1; 
            --text-muted: #949ba4;
            --accent-blue: #5865f2; 
            --accent-green: #23a559;
            --accent-red: #da373c;
            --bg-input: #383a40; 
            --bubble-sent: #4752c4; 
            --bubble-received: #3e4047;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        
        body { 
            background-color: var(--bg-sidebar); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
        }

        #app-wrapper { 
            display: flex; 
            height: 100vh; 
            width: 100vw; 
        }

        /* SIDEBAR */
        .sidebar { 
            width: 72px; 
            background-color: var(--bg-sidebar); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 12px 0; 
            gap: 12px; 
            flex-shrink: 0;
            border-right: 1px solid rgba(0,0,0,0.2);
        }

        .server-icon { 
            width: 48px; height: 48px; background: var(--bg-chat); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            transition: 0.2s; color: var(--accent-blue); font-weight: bold; font-size: 18px;
            position: relative;
        }
        
        .server-icon.active { border-radius: 16px; background: var(--accent-blue); color: white; }
        
        .sidebar-btn {
            width: 48px; height: 48px; border-radius: 50%; background: var(--bg-chat);
            border: none; color: var(--accent-green); font-size: 24px; cursor: pointer;
            transition: 0.2s;
        }

        .sidebar-btn:hover { border-radius: 16px; background: var(--accent-green); color: white; }
        
        .sidebar-btn.delete-btn {
            margin-top: auto; /* Pushes the delete button to the bottom */
            color: var(--accent-red);
            font-size: 20px;
        }

        .sidebar-btn.delete-btn:hover { background: var(--accent-red); color: white; }

        /* MAIN CHAT AREA */
        #chat-app { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background-color: var(--bg-chat); 
            position: relative;
        }

        .chat-header { 
            height: 48px; padding: 0 16px; display: flex; align-items: center; 
            justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.2); 
            background: var(--bg-chat);
        }

        #chat-thread { 
            flex: 1; overflow-y: auto; padding: 20px; display: flex; 
            flex-direction: column; gap: 12px; 
        }

        /* MESSAGES */
        .message { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.4; }
        .message.sent { align-self: flex-end; background: var(--bubble-sent); color: white; border-bottom-right-radius: 2px; }
        .message.received { align-self: flex-start; background: var(--bubble-received); border-bottom-left-radius: 2px; }
        .message.system { align-self: center; background: transparent; color: var(--text-muted); font-size: 11px; text-align: center; }

        /* INPUT AREA */
        .chat-input-area { padding: 10px 16px 20px 16px; display: flex; gap: 12px; align-items: center; background: var(--bg-chat); }
        
        #import-input { 
            flex: 1; background: var(--bg-input); border: none; border-radius: 8px; 
            color: white; padding: 12px; height: 44px; outline: none; resize: none;
        }

        .attach-btn, .send-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; }
        .send-btn { color: var(--accent-blue); }

        /* UTILITY BAR */
        .util-bar {
            position: absolute;
            bottom: 4px;
            right: 8px;
            display: flex;
            gap: 10px;
        }

        .util-link {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 10px;
            cursor: pointer;
            opacity: 0.5;
            transition: 0.2s;
        }

        .util-link:hover { opacity: 1; color: var(--accent-red); }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; z-index: 1000; }
        .modal-content-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; }
        .modal-content { max-width: 95%; max-height: 80%; transition: transform 0.2s; }
        .viewer-controls { padding: 20px; display: flex; justify-content: center; gap: 10px; background: var(--bg-sidebar); }
        .viewer-controls button { padding: 10px 20px; border-radius: 4px; border: none; background: var(--bg-input); color: white; cursor: pointer; }
        .close-viewer { position: absolute; top: 20px; right: 20px; font-size: 30px; color: white; cursor: pointer; }

        /* MOBILE OPTIMIZATION */
        @media (max-width: 600px) {
            .sidebar { width: 60px; }
            .server-icon, .sidebar-btn { width: 40px; height: 40px; }
            #import-input { font-size: 16px; } 
            .message { max-width: 90%; }
        }

        .hidden { display: none; }
        #packet-counter { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--accent-blue); padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div id="app-wrapper">
        <nav class="sidebar">
            <div class="server-icon active" title="VLink Home">VL</div>
            
            <div id="friends-list" style="display: flex; flex-direction: column; gap: 8px;"></div>
            
            <button id="add-friend-btn" class="sidebar-btn" title="Add Friend">+</button>
            
            <button id="delete-friend-btn" class="sidebar-btn delete-btn" title="Delete Selected Friend">×</button>
        </nav>

        <main id="chat-app">
            <header class="chat-header">
                <div class="header-main">
                    <h2 id="chat-target" style="font-size: 16px;">VLink Secure</h2>
                    <div id="status" style="font-size: 10px; color: var(--accent-green);">● Secure Protocol Active</div>
                </div>
                <div class="header-actions" style="display: flex; gap: 8px;">
                    <input type="password" id="secret-key" placeholder="Passcode" style="width: 80px; background: #1e1f22; border: 1px solid #4e5058; color: white; border-radius: 4px; padding: 2px 5px; font-size: 11px;">
                    <button id="show-qr-btn" style="background:none; border:none; color:white; font-size: 12px; cursor: pointer;">QR</button>
                </div>
            </header>

            <div id="qrcode" style="display:none; padding: 20px; background: white; margin: 10px; border-radius: 8px; align-self: center;"></div>

            <div id="chat-thread">
                <div class="message system">Welcome. Select a friend to start a secure SMS handover.</div>
            </div>

            <footer class="chat-input-area">
                <div id="packet-counter" class="hidden">0/0</div>
                
                <label for="file-input" class="attach-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </label>
                <input type="file" id="file-input" accept="image/*" style="display: none;">

                <textarea id="import-input" placeholder="Message or paste packet..."></textarea>
                
                <button id="chunk-btn" class="send-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </footer>

            <div class="util-bar">
                <button id="clear-chat-btn" class="util-link">Clear View</button>
                <button id="reset-receiver" class="util-link">Wipe All History</button>
            </div>
        </main>
    </div>

    <div id="image-viewer" class="modal">
        <span class="close-viewer">&times;</span>
        <div class="modal-content-wrapper">
            <img class="modal-content" id="full-image">
        </div>
        <div class="viewer-controls">
            <button onclick="adjustZoom(0.2)">+</button>
            <button onclick="adjustZoom(-0.2)">-</button>
            <button onclick="resetZoom()">Reset</button>
            <button id="download-btn" style="background: var(--accent-green);">Save</button>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>